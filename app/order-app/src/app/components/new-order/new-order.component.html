npm<div class="new-order-container">
  <!-- Search and Product Selection View (always visible unless success/error) -->
  <div *ngIf="currentStep !== 'success' && currentStep !== 'error'" class="search-view">
    <div class="search-section">
      <div class="search-bar">
        <input 
          type="text" 
          [(ngModel)]="searchQuery" 
          (ngModelChange)="onSearchInput()"
          (keyup.enter)="onSearch()"
          [placeholder]="'search.placeholder' | translate"
          class="search-input">
        <button class="barcode-btn" 
                title="Scan barcode" 
                (click)="startBarcodeScanning()"
                [disabled]="isScanningBarcode">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="3" y="6" width="2" height="12" fill="currentColor"/>
            <rect x="7" y="6" width="1" height="12" fill="currentColor"/>
            <rect x="10" y="6" width="1" height="12" fill="currentColor"/>
            <rect x="13" y="6" width="2" height="12" fill="currentColor"/>
            <rect x="17" y="6" width="1" height="12" fill="currentColor"/>
            <rect x="20" y="6" width="1" height="12" fill="currentColor"/>
          </svg>
        </button>
      </div>
      
      <div *ngIf="isSearching" class="loading">{{ 'search.searching' | translate }}</div>
      
      <!-- Barcode Scanner Modal -->
      <div *ngIf="isScanningBarcode" class="barcode-scanner-modal">
        <div class="scanner-overlay">
          <div class="scanner-container">
            <div class="scanner-header">
              <h3>{{ 'scanner.title' | translate }}</h3>
              <button class="close-scanner-btn" (click)="stopBarcodeScanning()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2"/>
                </svg>
              </button>
            </div>
            
            <div class="scanner-view">
              <div id="barcode-scanner" class="scanner-camera"></div>
              <div class="scanner-overlay-frame">
                <div class="scanner-corners">
                  <div class="corner top-left"></div>
                  <div class="corner top-right"></div>
                  <div class="corner bottom-left"></div>
                  <div class="corner bottom-right"></div>
                </div>
              </div>
            </div>
            
            <div class="scanner-instructions">
              <p>{{ 'scanner.instructions' | translate }}</p>
              <div *ngIf="scannerError" class="scanner-error">
                {{ scannerError }}
              </div>
            </div>
            
            <div class="scanner-controls">
              <button class="scanner-control-btn" (click)="stopBarcodeScanning()">
                {{ 'scanner.cancel' | translate }}
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <div *ngIf="!isSearching && searchQuery.trim().length > 0 && searchResults.length === 0" class="no-results">
        <p>{{ 'search.noProductsFound' | translate }} "{{ searchQuery }}"</p>
      </div>
      
      <div *ngIf="searchResults.length > 0 && !isSearching" class="search-results">
        <table class="results-table">
          <thead>
            <tr>
              <th>{{ 'table.id' | translate }}</th>
              <th>{{ 'table.ean' | translate }}</th>
              <th>{{ 'table.description' | translate }}</th>
              <th>{{ 'table.listPrice' | translate }}</th>
              <th>{{ 'table.unit' | translate }}</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let product of searchResults" 
                (click)="selectProduct(product)"
                [class.selected]="selectedProduct?.id === product.id">
              <td>{{ product.id }}</td>
              <td>{{ product.ean }}</td>
              <td>{{ product.description }}</td>
              <td>{{ product.listPrice | currency:'EUR':'symbol':'1.2-2' }}</td>
              <td>{{ product.unit }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="content-area">
      <div class="product-details">
        <div class="product-details-header">
          <h3>{{ 'productDetails.title' | translate }}</h3>
          <button class="refresh-btn" 
                  (click)="refreshPrices()" 
                  [disabled]="isRefreshingPrices"
                  [title]="'productDetails.refresh' | translate">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" 
                 [class.spinning]="isRefreshingPrices">
              <path d="M1 4v6h6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
        <div *ngIf="selectedProduct" class="product-info">
          <div class="product-image">
            <img [src]="getProductImageUrl(selectedProduct.id)" 
                 [alt]="selectedProduct.description"
                 (error)="onProductImageError(selectedProduct.id)"
                 (load)="onProductImageLoad(selectedProduct.id)"
                 [style.display]="isImageLoaded(selectedProduct.id) ? 'block' : 'none'">
            <div class="image-placeholder" [style.display]="isImageLoaded(selectedProduct.id) ? 'none' : 'flex'">
              <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="3" y="3" width="18" height="18" rx="2" stroke="#ccc" stroke-width="2" fill="#f5f5f5"/>
                <circle cx="8.5" cy="8.5" r="1.5" fill="#ccc"/>
                <path d="M21 15l-5-5L5 21" stroke="#ccc" stroke-width="2"/>
              </svg>
            </div>
          </div>
          <div class="product-data">
            <div class="product-header">
              <div class="product-main-info">
                <h4>{{ selectedProduct.description }}</h4>
                <p class="price">{{ selectedProduct.listPrice | currency:'EUR':'symbol':'1.2-2' }}</p>
                <p class="list-price">{{ 'productDetails.listPrice' | translate }}: {{ selectedProduct.listPrice | currency:'EUR':'symbol':'1.2-2' }}</p>
              </div>
              
              <div class="product-meta">
                <div class="meta-item">
                  <span class="meta-label">ID:</span>
                  <span class="meta-value">{{ selectedProduct.id }}</span>
                </div>
                <div class="meta-item">
                  <span class="meta-label">EAN:</span>
                  <span class="meta-value">{{ selectedProduct.ean }}</span>
                </div>
                <div class="meta-item">
                  <span class="meta-label">Unit:</span>
                  <span class="meta-value">{{ selectedProduct.unit }}</span>
                </div>
                
                <button class="add-to-cart-btn" (click)="addToCart(selectedProduct)">
                  {{ 'productDetails.addToCart' | translate }}
                </button>
              </div>
            </div>
            
            <div class="availability">
              <!-- Show no availability when OMSA has no data -->
              <div *ngIf="selectedProduct.availabilityDetails?.hasData === false" class="no-availability">
                <span class="stock-icon">⚠</span>
                <span>{{ 'productDetails.noAvailability' | translate }}</span>
                <span class="stock-source" *ngIf="selectedProduct.availabilityDetails?.source">
                  - {{ selectedProduct.availabilityDetails?.source }}
                </span>
              </div>
              
              <!-- Show availability when data is available -->
              <div *ngIf="selectedProduct.availabilityDetails?.hasData !== false">
                <div class="stock-info">
                  <span class="stock-icon">✓</span>
                  <span>{{ 'productDetails.inStore' | translate }} ({{ selectedProduct.inStoreStock }} {{ 'productDetails.pieces' | translate }})</span>
                  <span class="stock-source" *ngIf="selectedProduct.availabilityDetails?.source">
                    - {{ selectedProduct.availabilityDetails?.source }}
                  </span>
                </div>
                <div class="stock-info">
                  <span class="stock-icon">✓</span>
                  <span>{{ 'productDetails.online' | translate }} ({{ selectedProduct.onlineStock }} {{ 'productDetails.pieces' | translate }})</span>
                </div>
              </div>
            </div>
            
            <!-- Enhanced OMSA site availability details -->
            <div class="site-availability" *ngIf="selectedProduct.availabilityDetails?.sites?.length">
              <div class="site-header">
                <strong>{{ 'productDetails.detailedAvailability' | translate }}</strong>
                <span class="availability-timestamp" *ngIf="selectedProduct.availabilityDetails?.lastUpdated">
                  ({{ 'productDetails.updated' | translate }}: {{ selectedProduct.availabilityDetails?.lastUpdated | date:'short' }})
                </span>
              </div>
              <div class="site-list">
                <div class="site-item" *ngFor="let site of selectedProduct.availabilityDetails?.sites" 
                     [class]="'site-' + site.siteType">
                  <span class="site-icon" [class]="site.siteType">
                    <svg *ngIf="site.siteType === 'store'" width="16" height="16" viewBox="0 0 24 24" fill="none">
                      <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" stroke="currentColor" stroke-width="2"/>
                      <polyline points="9,22 9,12 15,12 15,22" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    <svg *ngIf="site.siteType === 'online'" width="16" height="16" viewBox="0 0 24 24" fill="none">
                      <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                      <path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" stroke="currentColor" stroke-width="2"/>
                    </svg>
                  </span>
                  <div class="site-details">
                    <span class="site-name">{{ site.siteName }}</span>
                    <span class="site-quantity">{{ site.quantity }} {{ selectedProduct.unit }}</span>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="other-locations" *ngIf="!selectedProduct.availabilityDetails?.sites?.length">
              <span>{{ 'productDetails.otherLocations' | translate }} ({{ (selectedProduct.inStoreStock || 0) + 20 }} {{ 'productDetails.pieces' | translate }}) ></span>
            </div>
          </div>
        </div>
        <div *ngIf="!selectedProduct" class="no-product">
          <div class="no-product-icon">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M20 7H4V5a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v2Z" stroke="currentColor" stroke-width="2"/>
              <path d="M4 7v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7" stroke="currentColor" stroke-width="2"/>
              <path d="M9 12h6" stroke="currentColor" stroke-width="2"/>
            </svg>
          </div>
          <p>{{ 'search.noResults' | translate }}</p>
          <p class="instruction">{{ 'search.placeholder' | translate }}</p>
        </div>
      </div>

      <div class="cart-section">
        <h3>{{ 'cart.title' | translate }}</h3>
        <div class="cart-content" *ngIf="cart$ | async as cart">
          <div *ngIf="cart.items.length === 0" class="empty-cart">
            <div class="empty-cart-icon">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 3h2l.4 2M7 13h10l4-8H5.4m1.6 8L5 3H3m4 10v6a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-6" stroke="currentColor" stroke-width="2"/>
              </svg>
            </div>
            <p>{{ 'cart.empty' | translate }}</p>
            <p class="instruction">{{ 'cart.emptyInstruction' | translate }}</p>
          </div>
          
          <div *ngIf="cart.items.length > 0" class="cart-items">
            <div class="cart-header">
              <span>{{ 'cart.product' | translate }}</span>
              <span>{{ 'cart.quantity' | translate }}</span>
              <span>{{ 'cart.listPrice' | translate }}</span>
              <span>{{ 'cart.price' | translate }}</span>
              <span>{{ 'cart.total' | translate }}</span>
            </div>
            
            <div *ngFor="let item of cart.items" class="cart-item">
              <div class="item-info">
                <img [src]="item.product.image" 
                     [alt]="item.product.description" 
                     class="item-image"
                     (error)="onImageErrorFallback($event)">
                <div class="item-details">
                  <span class="item-name">{{ item.product.description }}</span>
                  <span class="item-id">ID: {{ item.product.id }} | EAN: {{ item.product.ean }}</span>
                </div>
              </div>
              
              <div class="quantity-controls">
                <button (click)="updateQuantity(item.product.id, item.quantity - 1)" class="qty-btn">-</button>
                <span class="quantity">{{ item.quantity }}</span>
                <button (click)="updateQuantity(item.product.id, item.quantity + 1)" class="qty-btn">+</button>
              </div>
              
              <span class="list-price">{{ item.product.listPrice | currency:'EUR':'symbol':'1.2-2' }}</span>
              <span class="price">{{ item.price | currency:'EUR':'symbol':'1.2-2' }}</span>
              <span class="total">{{ item.total | currency:'EUR':'symbol':'1.2-2' }}</span>
              
              <button (click)="removeFromCart(item.product.id)" class="remove-btn" title="Remove item">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2"/>
                </svg>
              </button>
            </div>
            
            <div class="cart-totals">
              <div class="total-row">
                <span>{{ 'cart.totalOriginal' | translate }}</span>
                <span>{{ cart.totalPrice | currency:'EUR':'symbol':'1.2-2' }}</span>
              </div>
              <div class="total-row">
                <span>{{ 'cart.discount' | translate }}</span>
                <span>-{{ cart.discount | currency:'EUR':'symbol':'1.2-2' }}</span>
              </div>
              <div class="total-row final-total">
                <span>{{ 'cart.finalTotal' | translate }}</span>
                <span>{{ cart.finalTotal | currency:'EUR':'symbol':'1.2-2' }}</span>
              </div>
            </div>
            
            <div class="cart-actions">
              <button class="empty-cart-btn" (click)="emptyCart()">{{ 'cart.emptyCart' | translate }}</button>
              <button class="continue-btn" (click)="proceedToCustomerDetails()">{{ 'cart.continue' | translate }}</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Customer Details Section (appears at bottom) -->
  <div *ngIf="currentStep === 'customer' || currentStep === 'payment'" class="bottom-sections">
        <div *ngIf="currentStep === 'customer' || currentStep === 'payment'" class="customer-section" [class.completed]="currentStep === 'payment'">
      <div class="step-header">
        <button class="back-btn" (click)="goBackToCart()">← {{ 'common.back' | translate }}</button>
        <h2>{{ 'customer.title' | translate }}</h2>
        <div *ngIf="currentStep === 'payment'" class="step-status">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="10" stroke="#4CAF50" stroke-width="2"/>
            <path d="M8 12l2 2 4-4" stroke="#4CAF50" stroke-width="2" fill="none"/>
          </svg>
          <span>{{ 'customer.completed' | translate }}</span>
        </div>
      </div>
    
          <form [formGroup]="customerForm" class="customer-form" [class.readonly]="currentStep === 'payment'">
      <div class="form-section">
        <h3>Personal Information</h3>
        <div class="form-row">
          <div class="form-field">
            <label for="firstName">First name*</label>
            <input type="text" id="firstName" formControlName="firstName" required [readonly]="currentStep === 'payment'">
          </div>
          <div class="form-field">
            <label for="lastName">Last name*</label>
            <input type="text" id="lastName" formControlName="lastName" required [readonly]="currentStep === 'payment'">
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-field">
            <label for="email">Email*</label>
            <input type="email" id="email" formControlName="email" required [readonly]="currentStep === 'payment'">
          </div>
          <div class="form-field">
            <label for="phone">Phone number (optional)</label>
            <input type="tel" id="phone" formControlName="phone" [readonly]="currentStep === 'payment'">
          </div>
        </div>
      </div>
      
      <div class="form-section">
        <h3>Address Information</h3>
        <div class="form-field">
          <label for="addressLine1">Address Line 1*</label>
          <input type="text" id="addressLine1" formControlName="addressLine1" required [readonly]="currentStep === 'payment'">
        </div>
        
        <div class="form-field">
          <label for="addressLine2">Address Line 2</label>
          <input type="text" id="addressLine2" formControlName="addressLine2" [readonly]="currentStep === 'payment'">
        </div>
        
        <div class="form-row">
          <div class="form-field">
            <label for="zipCode">Zip Code*</label>
            <input type="text" id="zipCode" formControlName="zipCode" required [readonly]="currentStep === 'payment'">
          </div>
          <div class="form-field">
            <label for="city">City*</label>
            <input type="text" id="city" formControlName="city" required [readonly]="currentStep === 'payment'">
          </div>
        </div>
        
        <div class="form-field">
          <label for="country">Country*</label>
          <input type="text" id="country" formControlName="country" required [readonly]="currentStep === 'payment'">
        </div>
      </div>
      
      <div class="form-section">
        <h3>Shipping option</h3>
        <div class="shipping-options">
          <label *ngFor="let option of shippingOptions" class="shipping-option" [class.selected]="selectedShipping.id === option.id">
            <input type="radio" 
                   [value]="option.id" 
                   [(ngModel)]="selectedShipping" 
                   [ngModelOptions]="{standalone: true}"
                   [disabled]="currentStep === 'payment'"
                   (change)="selectedShipping = option">
            <span class="radio-custom"></span>
            <div class="option-details">
              <span class="option-name">{{ option.name }} ({{ option.price | currency:'EUR':'symbol':'1.2-2' }})</span>
              <span class="option-description">Delivery: {{ option.estimatedDays }} days</span>
            </div>
          </label>
        </div>
      </div>
      
      <div *ngIf="currentStep === 'customer'" class="form-actions">
        <button type="button" class="cancel-btn" (click)="goBackToCart()">Cancel Order</button>
        <button type="button" 
                class="continue-btn" 
                [disabled]="!customerForm.valid"
                (click)="proceedToPayment()">Continue to Payment</button>
      </div>
    </form>
    </div>

    <!-- Payment Section -->
    <div *ngIf="currentStep === 'payment'" class="payment-section">
    <div class="step-header">
      <button class="back-btn" (click)="goBackToCustomer()">← Back</button>
      <h2>Payment option</h2>
    </div>
    
    <div class="payment-content">
      <div class="payment-options">
        <label *ngFor="let option of paymentOptions" class="payment-option">
          <input type="radio" 
                 [value]="option.id" 
                 [(ngModel)]="selectedPayment" 
                 [ngModelOptions]="{standalone: true}"
                 (change)="selectedPayment = option">
          <span class="radio-custom"></span>
          <div class="option-details">
            <span class="option-name">{{ option.name }}</span>
            <span class="option-description">{{ option.description }}</span>
          </div>
        </label>
      </div>
      
      <div class="form-actions">
        <button type="button" class="cancel-btn" (click)="goBackToCart()">Cancel Order</button>
        <button type="button" class="place-order-btn" (click)="placeOrder()">Place Order</button>
      </div>
    </div>
    </div>
  </div>

  <!-- Success View -->
  <div *ngIf="currentStep === 'success'" class="success-view">
    <div class="success-content">
      <div class="success-icon">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" stroke="#4CAF50" stroke-width="2"/>
          <path d="M8 12l2 2 4-4" stroke="#4CAF50" stroke-width="2" fill="none"/>
        </svg>
      </div>
      <h2>Congratulations! The order has been placed successfully.</h2>
      <p>Order confirmation number: {{ orderConfirmation }}</p>
      <button class="new-order-btn" (click)="startNewOrder()">New Order</button>
    </div>
  </div>

  <!-- Error View -->
  <div *ngIf="currentStep === 'error'" class="error-view">
    <div class="error-content">
      <div class="error-icon">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" stroke="#f44336" stroke-width="2"/>
          <path d="M12 8v4m0 4h.01" stroke="#f44336" stroke-width="2"/>
        </svg>
      </div>
      <h2>Something went wrong and the order was not placed successfully :(</h2>
      <p>Please try again or contact your IT administrator.</p>
      <button class="new-order-btn" (click)="startNewOrder()">New Order</button>
    </div>
  </div>
</div> 